# WP Push from GitHub (WPGP)

非公開GitHubリポジトリで管理されているWordPressプラグインを、WordPressサイトに自動的に導入・更新するプラグインです。

## 概要

WP Push from GitHub（省略名：WPGP）は、GitHubで管理されているWordPressプラグインを、WordPress管理画面から簡単に導入・更新できるプラグインです。非公開リポジトリにも対応しており、Personal Access Tokenを使用して安全にアクセスできます。

## 主な機能

- ✅ GitHubリポジトリからのプラグイン自動更新
- ✅ 手動・自動更新チェック（WP Cron対応）
- ✅ バックアップとロールバック機能
- ✅ 管理画面・メール通知
- ✅ 更新履歴ログ
- ✅ ブランチ・タグ対応
- ✅ 非公開リポジトリ対応

## インストール方法

### 1. プラグインのアップロード

1. WordPress管理画面にログイン
2. 「プラグイン」→「新規追加」をクリック
3. 「プラグインのアップロード」をクリック
4. `github-push.zip`を選択してアップロード
5. 「今すぐインストール」をクリック
6. インストール完了後、「プラグインを有効化」をクリック

### 2. プラグインの有効化

「プラグイン」メニューから「WP Push from GitHub」を有効化してください。

## 使い方

### 基本的な使い方

1. **GitHubリポジトリの準備**
   - 更新したいプラグインをGitHubリポジトリで管理
   - 非公開リポジトリの場合は、Personal Access Tokenを準備

2. **プラグインの登録**
   - WordPress管理画面の「WPGP」メニューを開く
   - 「新しいプラグインを追加」ボタンをクリック
   - 必要な情報を入力して保存

3. **更新の実行**
   - プラグイン一覧から「更新チェック」ボタンをクリック
   - 更新が利用可能な場合は「更新」ボタンで更新を実行

### 設定項目の説明

#### GitHubリポジトリURL
GitHubリポジトリのURLを入力します。

**対応形式：**
- `https://github.com/owner/repo`
- `git@github.com:owner/repo.git`

#### 更新方法

**タグを使用する場合：**
- チェックボックスにチェックを入れる
- GitHubのタグ（例: v1.0.0）から最新バージョンを取得します
- リポジトリにタグが作成されている必要があります

**ブランチを使用する場合：**
- チェックボックスを外す
- 指定したブランチ（デフォルト: `main`）の最新コミットから更新を取得します
- プラグインファイルのバージョンヘッダーからバージョンを取得します

**重要：ブランチを使用する場合のバージョン記載方法**

ブランチを使用して更新する場合、プラグインの更新チェックは**プラグインファイルのバージョンヘッダー**を参照します。プラグインのメインファイル（例：`my-plugin.php`）に、必ず正しいバージョン情報を記載してください。

**プラグインファイルのバージョンヘッダー例：**

```php
<?php
/**
 * Plugin Name: My Plugin
 * Plugin URI: https://example.com/my-plugin
 * Description: プラグインの説明
 * Version: 1.0.0
 * Author: Your Name
 * Author URI: https://example.com
 * License: GPL v2 or later
 * License URI: https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain: my-plugin
 */
```

**注意点：**
- `Version:` の後に、セマンティックバージョニング（例：`1.0.0`、`1.2.3`）を記載してください
- バージョンを更新するたびに、このヘッダーのバージョン番号も更新してください
- バージョンが正しく記載されていない場合、更新チェックが正常に動作しない可能性があります

**タグを使用する場合：**
タグを使用する場合は、GitHubのタグ名がバージョンとして使用されます。プラグインファイルのバージョンヘッダーは参照されませんが、WordPressの標準に従って記載することを推奨します。

#### プラグインスラッグ
WordPressプラグインディレクトリ内のプラグインファイルのパスを指定します。

**例：**
- `my-plugin/my-plugin.php`
- `custom-plugin/custom-plugin.php`

#### Personal Access Token
非公開リポジトリにアクセスする場合は必須です。

**トークンの生成方法：**
1. GitHubにログイン
2. [Settings](https://github.com/settings/tokens) → [Developer settings](https://github.com/settings/apps) → [Personal access tokens](https://github.com/settings/tokens) → [Tokens (classic)](https://github.com/settings/tokens?type=beta)
3. 「Generate new token」をクリック
4. 必要な権限を選択（最低限 `repo` 権限が必要）
5. トークンを生成し、コピーして貼り付け

**注意：** トークンは安全に管理してください。他人に共有しないでください。

#### 自動更新

各プラグインごとに自動更新の設定が可能です。

**自動更新を有効にする：**
- チェックボックスにチェックを入れると、更新が利用可能な場合に自動的に更新を実行します
- チェックを外すと、更新が利用可能な場合に通知のみが送信されます

**自動更新チェック間隔：**
- 何時間ごとに更新をチェックするかを設定できます（1〜168時間）
- デフォルト: 1時間
- 各プラグインで異なる間隔を設定できます

**設定ページでの確認：**
- プラグイン一覧画面の「自動更新」列で、各プラグインの自動更新状態を確認できます
- 有効な場合：緑色のチェックマークとチェック間隔、最終チェック時刻が表示されます
- 無効な場合：赤色のXマークと「無効」が表示されます

## 機能詳細

### 手動更新チェック

プラグイン一覧画面から「更新チェック」ボタンをクリックすると、GitHubリポジトリの最新バージョンをチェックします。チェック結果はログに記録されます。

**ログに記録される内容：**
- 更新が利用可能な場合：「更新が利用可能です。現在: X → 最新: Y」
- 更新がない場合：「更新はありません。現在のバージョン: X」
- エラーが発生した場合：エラーメッセージ

### 自動更新チェック

WP Cronを使用して、定期的に更新をチェックします。各プラグインの設定に基づいて、指定した間隔で自動的にチェックが実行されます（デフォルト: 1時間ごと）。

**動作：**
- 1時間ごとにCronイベントが実行されます
- 各プラグインの設定されたチェック間隔が経過している場合のみ、更新チェックを実行します
- チェック結果はログに記録されます

**ログに記録される内容：**
- 更新が利用可能な場合：「自動更新チェック: 更新が利用可能です。現在: X → 最新: Y」
- 更新がない場合：「自動更新チェック: 更新はありません。現在のバージョン: X」
- エラーが発生した場合：エラーメッセージ
- 自動更新が有効な場合、更新が実行されると「update」アクションのログも記録されます

### バックアップ機能

プラグインを更新する前に、自動的にバックアップを作成します。最大5つのバックアップを保持します。

### ロールバック機能

更新後に問題が発生した場合、ログタブから特定のバージョンに戻すことができます。

**ロールバックとは：**
- プラグインを更新する前に自動的に作成されたバックアップから、前のバージョンに復元する機能です
- 更新後にエラーが発生したり、動作がおかしくなった場合に使用します
- バックアップは最大5つまで保持されます（古いバックアップは自動的に削除されます）

**使用方法：**
1. 「ログ」メニューを開く
2. 更新成功のログエントリを確認
3. 「このバージョンに戻す」ボタンが表示されている場合、クリック
4. 確認ダイアログで「OK」をクリック
5. プラグインがそのバージョンに復元されます

**注意点：**
- ロールバックボタンは、更新成功のログで、バックアップが存在する場合のみ表示されます
- バックアップが存在しない場合は、ロールバックボタンは表示されません
- ロールバック後も、プラグインの有効化状態は維持されます
- ロールバックの実行もログに記録されます

### 通知機能

- **管理画面通知**：更新完了やエラー発生時に管理画面に通知を表示
- **メール通知**：オプションでメール通知も可能（設定画面で有効化）

### ログ機能

すべての更新履歴とエラーログを記録します。「ログ」メニューから確認できます。

**ログに記録される内容：**

1. **手動更新チェック** (`version_check`)
   - 更新が利用可能な場合：成功ログ
   - 更新がない場合：情報ログ
   - エラーが発生した場合：エラーログ

2. **自動更新チェック** (`version_check`)
   - 更新が利用可能な場合：成功ログ（「自動更新チェック:」というプレフィックス付き）
   - 更新がない場合：情報ログ（「自動更新チェック:」というプレフィックス付き）
   - エラーが発生した場合：エラーログ

3. **プラグイン更新** (`update`)
   - 更新成功時：成功ログ（バージョン情報付き）
   - 更新失敗時：エラーログ

4. **ロールバック** (`rollback`)
   - ロールバック成功時：成功ログ（バージョン情報付き）
   - ロールバック失敗時：エラーログ

5. **バックアップ作成** (`backup`)
   - バックアップ失敗時：エラーログ

**ログ画面の機能：**
- プラグインごとにフィルター可能
- 各ログエントリに日時、プラグイン名、アクション、ステータス、バージョン、メッセージが表示されます
- 更新成功のログで、バックアップが存在する場合、「このバージョンに戻す」ボタンが表示されます
- ページネーション対応（1ページあたり50件）

## トラブルシューティング

### 更新が失敗する

1. **Personal Access Tokenを確認**
   - 非公開リポジトリの場合は、トークンが正しく設定されているか確認
   - トークンの権限が適切か確認（`repo`権限が必要）

2. **プラグインスラッグを確認**
   - プラグインスラッグが正しいか確認
   - プラグインが実際にインストールされているか確認

3. **GitHubリポジトリURLを確認**
   - URLが正しいか確認
   - リポジトリが存在するか確認

4. **ログを確認**
   - 「ログ」メニューからエラーメッセージを確認

### ロールバックができない

- ログタブで、更新成功のログエントリに「このバージョンに戻す」ボタンが表示されているか確認
- バックアップが存在するか確認（バックアップファイルが削除されている可能性があります）
- ログの日時より前のバックアップが存在する必要があります

### 自動更新チェックが動作しない

- プラグインの設定で「自動更新」が有効になっているか確認
- チェック間隔が正しく設定されているか確認
- 設定ページの「自動更新」列で、最終チェック時刻が更新されているか確認
- WP Cronが正常に動作しているか確認
- サーバーのcron設定を確認
- ログタブで自動更新チェックのログが記録されているか確認

### タグが見つからないエラーが表示される

- GitHubリポジトリにタグが作成されているか確認
- 「タグを使用する」のチェックを外して、ブランチを使用する方法に変更することを検討
- Personal Access Tokenが正しく設定されているか確認（非公開リポジトリの場合）

## システム要件

- WordPress 5.0以上
- PHP 7.4以上
- ZipArchive拡張機能（PHPに含まれていることが多い）

## セキュリティ

- すべてのフォーム送信でnonce検証を実施
- 管理者権限のチェック
- 入力値のサニタイズと出力のエスケープ
- Personal Access Tokenは暗号化して保存（推奨：将来的な機能）

## ライセンス

GPL v2 or later

## サポート

問題が発生した場合や質問がある場合は、以下をご確認ください：

1. ログ画面でエラーメッセージを確認
2. WordPressのデバッグモードを有効化してエラーを確認
3. GitHubリポジトリのIssuesで報告

## 更新履歴

### 1.0.0
- 初回リリース
- GitHubリポジトリからのプラグイン自動更新機能
- 手動・自動更新チェック（各プラグインごとに設定可能）
- 自動更新チェック間隔の設定（デフォルト: 1時間）
- バックアップとロールバック機能（ログタブから実行）
- 通知機能（管理画面・メール）
- 詳細なログ機能（手動チェック、自動チェック、更新、ロールバック）
- 設定ページでの自動更新状態の確認
- プラグイン名の自動取得
- プラグインスラッグのドロップダウン選択

## 開発者向け情報

### フック

プラグインは以下のフックを提供しています（将来的な拡張用）：

- `github_push_before_update` - 更新前
- `github_push_after_update` - 更新後
- `github_push_before_rollback` - ロールバック前
- `github_push_after_rollback` - ロールバック後

### カスタマイズ

プラグインの動作をカスタマイズする場合は、テーマの`functions.php`またはカスタムプラグインでフックを使用してください。

## クレジット

開発: Technophere
公式サイト: https://technophere.codm

---

**注意：** このプラグインを使用する前に、必ずバックアップを取得してください。特に本番環境では、テスト環境で十分に動作確認を行ってから使用することをお勧めします。

